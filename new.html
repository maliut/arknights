<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>明日方舟作业帮</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
    <link href="actors.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">明日方舟作业帮</a>
            </div>
        </div><!-- /.container-fluid -->
    </nav>

    <div class="container-fluid">
        <div class="panel panel-primary">
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-10">
                        <div style="padding:6px 0">
                            打开 Bilibili 视频页面，在开发者工具中运行下列代码，并将运行结果粘贴到下方的文本框中。
                            <span class="bg-warning">关卡推测可能不准确，如有错误，请手动修复！！！</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-default pull-right" type="button" onclick="copyCode()">复制代码</button>
                    </div>
                </div>
            </div>
            <div class="panel-body">
                <pre id="m-bilibili-code"
                    style="white-space:normal">
                    ;eval(function(p,a,c,k,e,r){e=function(c){return c.toString(a)};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('6 4=$(".g")[0].8;6 5=(/9=(\\d+)&b=(\\d+)&c=(\\d+)/).e($("#h").i());6 7=(($(".j-k>.l>a")[0]||{}).4||"")+4;m.n({4:4,o:$(".p")[0].8,9:5[1],b:5[2],c:q(5[3]),r:(((/\\f+(-\\f+)+/).e(7)||{})[0]||"").s(),t:7.u("突袭")>=0});',31,31,'||||title|ids|let|indicate|innerText|aid||cid|page||exec|w|tit|link2|val|list|box|on|JSON|stringify|author|username|parseInt|level|toUpperCase|tuxi|indexOf'.split('|'),0,{}));                </pre>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="m-info-input" class="form-control" placeholder="粘贴结果到此处">
            <span class="input-group-btn">
                <button class="btn btn-primary" type="button" onclick="parseVideoInfo()">开始分析</button>
            </span>
        </div><!-- /input-group -->

        <div class="panel panel-info" style="margin-top:20px">
            <div class="panel-heading">
                <h3 class="panel-title">基本信息</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">标题</span>
                            <input type="text" id="m-info-title" class="form-control" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">关卡</span>
                            <input type="text" id="m-info-level" class="form-control" aria-describedby="basic-addon1">
                            <span class="input-group-btn">
                                <button id="m-info-tuxi" class="btn btn-default" type="button" data-toggle="button"
                                    aria-pressed="false" autocomplete="off">突袭</button>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">作者</span>
                            <input type="text" id="m-info-author" class="form-control" aria-describedby="basic-addon1">
                        </div>
                    </div>

                </div>
                <div class="row" style="margin-top:15px">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">aid</span>
                            <input type="text" id="m-info-aid" class="form-control" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">cid</span>
                            <input type="text" id="m-info-cid" class="form-control" aria-describedby="basic-addon1">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">page</span>
                            <input type="text" id="m-info-page" class="form-control" aria-describedby="basic-addon1">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-info" id="m-actors-panel-parent">
            <div class="panel-heading">
                <h3 class="panel-title">干员列表<span style="font-size: 13px">&nbsp;&nbsp;|&nbsp;已选：<span id="m-actors-count">0</span></span></h3>
            </div>
        </div>


        <button type="button" id="m-btn-submit" class="btn btn-primary" style="width:100%;margin-bottom:20px"
            onclick="submit()">提交作业</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.15.0/dist/av-min.js"></script>
    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script src="actors.js"></script>
    <script src="levels.js"></script>
    <script>
        initPanel(0);

        function parseVideoInfo() {
            let input = $("#m-info-input");
            let raw = input.val().trim();
            if (raw[0] === '"') raw = raw.substring(1, raw.length - 1);
            try {
                let info = JSON.parse(raw);
                $("#m-info-title").val(info.title);
                $("#m-info-level").val(info.level);
                if (info.tuxi) $("#m-info-tuxi").click();
                $("#m-info-author").val(info.author);
                $("#m-info-aid").val(info.aid);
                $("#m-info-cid").val(info.cid);
                $("#m-info-page").val(info.page);
                input.css("border-color", "#cccccc");
            } catch (err) {
                input.css("border-color", "#d43f3a");
            }
        }

        function copyCode() {
            let tmpi = $("<input />").val($("#m-bilibili-code").text());//.hide();
            $("body").append(tmpi);
            tmpi.select();
            document.execCommand("Copy");
            tmpi.remove();
        }

        function submit() {
            if (!AV.User.current()) {
                alert("你没有权限！");
                return;
            }
            
            let aid = $("#m-info-aid").val().trim();
            let page = $("#m-info-page").val().trim();
            if (aid === "") {
                alert("数据不完整！");
                return;
            }
            $("#m-btn-submit").toggleClass("m-btn-loading");
            let query = new AV.Query("Homework");
            query.equalTo('aid', aid + "_" + page);
            query.find().then(function (works) {
                if (works.length > 0) {
                    alert("似乎已经有相同的作业了！");
                    $("#m-btn-submit").toggleClass("m-btn-loading");
                } else {
                    _doSaveObj();
                }
            }, function (e) {
                if (e.code === 101) {
                    _doSaveObj();
                } else {
                    console.log(e.code);
                    alert("查询失败，请联系管理员");
                    $("#m-btn-submit").toggleClass("m-btn-loading");
                }
            });
        }

        function _doSaveObj() {
            let level = $("#m-info-level").val().trim() + ($("#m-info-tuxi").attr("aria-pressed") === "true" ? "突袭" : "");
            if (!_validateLevel(level)) {
                alert("关卡名不正确，请检查拼写或联系管理员");
                $("#m-btn-submit").toggleClass("m-btn-loading");
                return;
            }
            let work = new AV.Object("Homework");
            work.set('title', $("#m-info-title").val().trim());
            work.set('author', $("#m-info-author").val().trim());
            work.set('level', level);
            work.set('aid', $("#m-info-aid").val().trim() + "_" + $("#m-info-page").val().trim());
            work.set('cid', $("#m-info-cid").val().trim());
            work.set('actors', getCurrentSelectedActors().include);
            work.save().then(function (work1) {
                alert("保存成功！");
                $("#m-btn-submit").toggleClass("m-btn-loading");
            }, function (e) {
                console.log(e.code);
                alert("保存失败，请联系管理员");
                $("#m-btn-submit").toggleClass("m-btn-loading");
            });
        }

        function _validateLevel(level) {
            for (let ch in levels) {
                if (levels[ch].includes(level)) {
                    return true;
                }
            }
            return false;
        }
    </script>
</body>

</html>